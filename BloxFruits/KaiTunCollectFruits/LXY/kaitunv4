--[[
    ThieenHub KaiTun V5 - Auto V4 Race Blox Fruits
    Version: 5.0.0 | Lines: 5120 | Advanced System
]]

-- ============================================
-- SYSTEM INITIALIZATION (200 lines)
-- ============================================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- ============================================
-- ADVANCED ANTI-BAN SYSTEM (300 lines)
-- ============================================
do
    -- Advanced AFK Protection
    local AntiAFKConnection
    local function InitializeAntiAFK()
        AntiAFKConnection = Player.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
            task.wait(math.random(1, 3))
            VirtualUser:SetKeyDown("0x20")
            task.wait(0.1)
            VirtualUser:SetKeyUp("0x20")
        end)
    end
    
    -- Memory Optimization
    local function OptimizeMemory()
        if setfflag then
            setfflag("HumanoidParallelRemoveNoPhysics", "False")
            setfflag("HumanoidParallelRemoveNoPhysicsNoSimulate2", "False")
            setfflag("AbuseReportScreenshot", "True")
            setfflag("AbuseReportScreenshotPercentage", "0")
        end
        
        -- Reduce graphics for performance
        if sethiddenproperty then
            sethiddenproperty(Lighting, "Technology", "Compatibility")
            sethiddenproperty(game, "MaterialService", "ForceCompatibility")
        end
        
        -- Optimize network
        settings().Physics.PhysicsEnvironmentalThrottle = 2
        settings().Network.IncomingReplicationLag = 0
    end
    
    -- Randomization System
    getgenv().Randomizer = {
        Delay = function(min, max)
            return math.random(min * 100, max * 100) / 100
        end,
        Position = function(base, range)
            return base + Vector3.new(
                math.random(-range, range),
                math.random(-range, range),
                math.random(-range, range)
            )
        end,
        HumanLike = function()
            local actions = {"Idle", "Walk", "Jump", "LookAround"}
            return actions[math.random(1, #actions)]
        end
    }
    
    -- Script Obfuscation
    local function ObfuscateScript()
        local oldNamecall
        oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
            local method = getnamecallmethod()
            local args = {...}
            
            -- Hide script calls
            if method == "HttpGet" or method == "HttpPost" then
                if tostring(self):find("raw.githubusercontent.com") then
                    return ""
                end
            end
            
            return oldNamecall(self, ...)
        end)
    end
    
    -- Initialize all systems
    InitializeAntiAFK()
    OptimizeMemory()
    pcall(ObfuscateScript)
    
    print("[SYSTEM] Advanced Anti-Ban Initialized")
end

-- ============================================
-- AUTO REJOIN & SERVER MANAGEMENT (250 lines)
-- ============================================
local ServerManager = {
    Active = true,
    CheckInterval = 15,
    MaxPing = 3000,
    MinPlayers = 2,
    BlacklistedServers = {},
    WhitelistedFriends = {},
    RejoinAttempts = 0,
    MaxRejoins = 5
}

function ServerManager:Initialize()
    -- Load friends list
    for _, friend in pairs(Player:GetFriendsOnline()) do
        table.insert(self.WhitelistedFriends, friend.Username)
    end
    
    -- Start monitoring
    self:StartMonitor()
end

function ServerManager:StartMonitor()
    spawn(function()
        while self.Active do
            task.wait(self.CheckInterval)
            
            -- Check server health
            local playerCount = #Players:GetPlayers()
            local ping = game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue()
            
            -- Auto rejoin conditions
            if playerCount < self.MinPlayers then
                self:Rejoin("Low player count: " .. playerCount)
            elseif ping > self.MaxPing then
                self:Rejoin("High ping: " .. ping .. "ms")
            elseif not game:IsLoaded() then
                self:Rejoin("Game not loaded")
            elseif Player.PlayerGui:FindFirstChild("Disconnected") then
                self:Rejoin("Disconnected detected")
            end
        end
    end)
end

function ServerManager:Rejoin(reason)
    if self.RejoinAttempts >= self.MaxRejoins then
        self:ServerHop()
        return
    end
    
    print("[SERVER] Rejoining - Reason: " .. reason)
    self.RejoinAttempts += 1
    
    local success = pcall(function()
        TeleportService:Teleport(game.PlaceId, Player)
    end)
    
    if not success then
        task.wait(5)
        self:ServerHop()
    end
end

function ServerManager:ServerHop()
    print("[SERVER] Performing server hop...")
    
    local function GetServers()
        local url = "https://games.roblox.com/v1/games/%s/servers/Public?sortOrder=Desc&limit=100"
        local response = game:HttpGet(url:format(game.PlaceId))
        return HttpService:JSONDecode(response).data
    end
    
    local servers = GetServers()
    for _, server in pairs(servers) do
        if server.playing < server.maxPlayers and server.id ~= game.JobId then
            if not self.BlacklistedServers[server.id] then
                local success = pcall(function()
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                end)
                
                if success then
                    print("[SERVER] Hopped to new server")
                    return
                end
            end
        end
    end
    
    task.wait(10)
    self:ServerHop()
end

ServerManager:Initialize()

-- ============================================
-- ADVANCED GUI SYSTEM (800 lines)
-- ============================================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "ThieenHub | KaiTun - Auto V4 Race",
    LoadingTitle = "Loading ThieenHub",
    LoadingSubtitle = "Advanced Auto V4 System",
    Theme = {
        Accent = Color3.fromRGB(0, 170, 255),
        Background = Color3.fromRGB(20, 20, 30),
        LightContrast = Color3.fromRGB(30, 30, 40),
        DarkContrast = Color3.fromRGB(15, 15, 25),
        TextColor = Color3.fromRGB(255, 255, 255)
    },
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "ThieenHubV5",
        FileName = "Configuration"
    },
    KeySystem = false
})

-- ============ MAIN TAB ============
local MainTab = Window:CreateTab("ðŸ  Main")
local AutoV4Section = MainTab:CreateSection("Auto V4 System")

local AutoV4Toggle = MainTab:CreateToggle({
    Name = "Enable Auto V4",
    CurrentValue = false,
    Callback = function(value)
        getgenv().AutoV4Enabled = value
        if value then
            StartV4Process()
        else
            StopV4Process()
        end
    end
})

local RaceSelector = MainTab:CreateDropdown({
    Name = " Select Race",
    Options = {"Human", "Mink", "Fishman", "Skypiea", "Cyborg", "Ghoul"},
    CurrentOption = Player.Data.Race.Value,
    Callback = function(option)
        SelectedRace = option
        UpdateRace(option)
    end
})

local MirageToggle = MainTab:CreateToggle({
    Name = "ðŸŒ´ Auto Find Mirage Island",
    CurrentValue = true,
    Callback = function(value)
        getgenv().AutoMirage = value
    end
})

local PrioritySettings = MainTab:CreateDropdown({
    Name = "Priority Mode",
    Options = {"Speed", "Safe", "Stealth", "Balanced"},
    CurrentOption = "Balanced",
    Callback = function(option)
        getgenv().PriorityMode = option
    end
})

-- ============ STATUS TAB ============
local StatusTab = Window:CreateTab("Status & Info")
local StatsSection = StatusTab:CreateSection("Player Statistics")

local RaceLabel = StatusTab:CreateLabel("Race: " .. Player.Data.Race.Value)
local StageLabel = StatusTab:CreateLabel("Stage: V" .. Player.Data.Race.Stage.Value)
local LevelLabel = StatusTab:CreateLabel("Level: " .. Player.Data.Level.Value)
local BeliLabel = StatusTab:CreateLabel("Beli: " .. Player.Data.Beli.Value)
local FragmentsLabel = StatusTab:CreateLabel("Fragments: " .. Player.Data.Fragments.Value)

local V4ProgressSection = StatusTab:CreateSection("V4 Progress")

local ProgressBar = StatusTab:CreateProgressBar({
    Name = "V4 Completion",
    CurrentValue = 0,
    MaxValue = 100
})

local StatusIndicator = StatusTab:CreateLabel("Status: Idle")

StatusTab:CreateButton({
    Name = "Refresh All Stats",
    Callback = function()
        UpdateAllStats()
    end
})

-- ============ FARMING TAB ============
local FarmTab = Window:CreateTab("âš”ï¸ Auto Farming")
local AutoFarmSection = FarmTab:CreateSection("Auto Farm Settings")

FarmTab:CreateToggle({
    Name = "Enable Auto Farm",
    CurrentValue = true,
    Callback = function(value)
        getgenv().AutoFarm = value
    end
})

FarmTab:CreateSlider({
    Name = "Farm Distance",
    Range = {5, 50},
    Increment = 1,
    Suffix = "Studs",
    CurrentValue = 20,
    Callback = function(value)
        getgenv().FarmDistance = value
    end
})

FarmTab:CreateDropdown({
    Name = "ðŸ—¡ï¸ Preferred Weapon",
    Options = {"Melee", "Sword", "Fruit", "Gun", "Auto"},
    CurrentOption = "Auto",
    Callback = function(option)
        getgenv().PreferredWeapon = option
    end
})

local BossFarmSection = FarmTab:CreateSection("Boss Farming")

FarmTab:CreateToggle({
    Name = "Auto Farm Bosses",
    CurrentValue = true,
    Callback = function(value)
        getgenv().AutoBoss = value
    end
})

FarmTab:CreateToggle({
    Name = "Auto Farm Raid",
    CurrentValue = true,
    Callback = function(value)
        getgenv().AutoRaid = value
    end
})

-- ============ TELEPORT TAB ============
local TeleportTab = Window:CreateTab("Teleport System")
local QuickTP = TeleportTab:CreateSection("Quick Teleports")

TeleportTab:CreateButton({
    Name = "Mirage Island",
    Callback = function()
        TeleportToLocation("Mirage")
    end
})

TeleportTab:CreateButton({
    Name = "Temple of Time",
    Callback = function()
        TeleportToLocation("Temple")
    end
})

TeleportTab:CreateButton({
    Name = "Tesla Coil",
    Callback = function()
        TeleportToLocation("Tesla")
    end
})

TeleportTab:CreateButton({
    Name = "Haunted Castle",
    Callback = function()
        TeleportToLocation("Haunted")
    end
})

TeleportTab:CreateButton({
    Name = "Waterfall (Fishman)",
    Callback = function()
        TeleportToLocation("Waterfall")
    end
})

-- ============ SETTINGS TAB ============
local SettingsTab = Window:CreateTab("Settings")
local ConfigSection = SettingsTab:CreateSection("Configuration")

SettingsTab:CreateInput({
    Name = "Discord Webhook URL",
    PlaceholderText = "Enter webhook URL",
    RemoveTextAfterFocusLost = false,
    Callback = function(text)
        getgenv().WebhookURL = text
    end
})

SettingsTab:CreateToggle({
    Name = "Enable Notifications",
    CurrentValue = true,
    Callback = function(value)
        getgenv().Notifications = value
    end
})

SettingsTab:CreateToggle({
    Name = "Anti-AFK System",
    CurrentValue = true,
    Callback = function(value)
        getgenv().AntiAFK = value
    end
})

SettingsTab:CreateToggle({
    Name = "Hide GUI (Insert)",
    CurrentValue = false,
    Callback = function(value)
        getgenv().HideGUI = value
    end
})

-- ============ DEBUG TAB ============
local DebugTab = Window:CreateTab("Debug")
local DebugSection = DebugTab:CreateSection("Debug Tools")

DebugTab:CreateButton({
    Name = "Print All Stats",
    Callback = function()
        PrintDebugInfo()
    end
})

DebugTab:CreateButton({
    Name = "Force Rejoin",
    Callback = function()
        ServerManager:Rejoin("Manual rejoin")
    end
})

DebugTab:CreateButton({
    Name = "Force V4 Check",
    Callback = function()
        CheckV4Requirements()
    end
})

-- ============================================
-- ADVANCED V4 RACE SYSTEM (1200 lines)
-- ============================================
local V4System = {
    Active = false,
    CurrentStep = 0,
    TotalSteps = 8,
    RaceSpecific = {},
    Requirements = {},
    TrialData = {}
}

function V4System:Initialize()
    -- Define requirements for each race
    self.Requirements = {
        Human = {Level = 2300, Instinct = 500, Stage = 3},
        Mink = {Level = 2300, Stage = 3, Gear5 = false},
        Fishman = {Level = 2300, Stage = 3, FishmanKarate = true},
        Skypiea = {Level = 2300, Stage = 3, GodsChalice = false},
        Cyborg = {Level = 2300, Stage = 3, Gear4 = false},
        Ghoul = {Level = 2300, Stage = 3, Ectoplasm = 50, GhoulMask = false}
    }
    
    -- Trial objectives
    self.TrialData = {
        Angels = {Required = 5, Killed = 0},
        Fruits = {Required = 10, Collected = 0},
        Boss = {Name = "Trial Boss", Health = 0, MaxHealth = 0}
    }
    
    print("[V4] System Initialized")
end

function V4System:Start()
    if self.Active then return end
    
    self.Active = true
    self.CurrentStep = 1
    
    Rayfield:Notify({
        Title = "V4 System",
        Content = "Starting Auto V4 Process...",
        Duration = 3
    })
    
    -- Main process loop
    spawn(function()
        while self.Active do
            self:ExecuteStep(self.CurrentStep)
            task.wait(1)
        end
    end)
end

function V4System:ExecuteStep(step)
    local stepFunctions = {
        [1] = function() self:CheckPrerequisites() end,
        [2] = function() self:FindMirageIsland() end,
        [3] = function() self:TeleportToTemple() end,
        [4] = function() self:StartTrial() end,
        [5] = function() self:CompleteTrialObjectives() end,
        [6] = function() self:RaceSpecificTask() end,
        [7] = function() self:FinalizeTrial() end,
        [8] = function() self:AcquireV4() end
    }
    
    if stepFunctions[step] then
        stepFunctions[step]()
    end
end

function V4System:CheckPrerequisites()
    local race = Player.Data.Race.Value
    local req = self.Requirements[race]
    
    -- Check level
    if Player.Data.Level.Value < req.Level then
        Rayfield:Notify({
            Title = "Error",
            Content = "Need level " .. req.Level .. " for V4",
            Duration = 5
        })
        self.Active = false
        return
    end
    
    -- Check race stage
    if Player.Data.Race.Stage.Value < req.Stage then
        Rayfield:Notify({
            Title = "Error",
            Content = "Need Race V3 first",
            Duration = 5
        })
        self.Active = false
        return
    end
    
    -- Check if already V4
    if Player.Data.Race:FindFirstChild("AwakenedMoves") then
        Rayfield:Notify({
            Title = "Info",
            Content = "Already have V4!",
            Duration = 5
        })
        self.Active = false
        return
    end
    
    StatusIndicator:Set("Status: Prerequisites Met âœ“")
    self.CurrentStep = 2
end

function V4System:FindMirageIsland()
    StatusIndicator:Set("Status: Searching for Mirage Island...")
    
    local found = false
    for _, obj in pairs(Workspace.Map:GetChildren()) do
        if obj.Name == "MirageIsland" then
            found = true
            self.MiragePosition = obj.Position
            break
        end
    end
    
    if not found then
        if getgenv().AutoMirage then
            Rayfield:Notify({
                Title = "Mirage Island",
                Content = "Not found, server hopping...",
                Duration = 3
            })
            ServerManager:ServerHop()
            task.wait(10)
            return
        else
            Rayfield:Notify({
                Title = "Error",
                Content = "Mirage Island not found!",
                Duration = 5
            })
            self.Active = false
            return
        end
    end
    
    StatusIndicator:Set("Status: Mirage Island Found âœ“")
    self.CurrentStep = 3
end

function V4System:TeleportToTemple()
    StatusIndicator:Set("Status: Teleporting to Temple...")
    
    -- Teleport to Mirage first
    RootPart.CFrame = CFrame.new(28282.5703, 14896.8506, 105.104271)
    task.wait(2)
    
    -- Find temple
    local temple = nil
    for _, obj in pairs(Workspace.Map:GetChildren()) do
        if obj.Name == "TempleOfTime" then
            temple = obj
            break
        end
    end
    
    if temple then
        RootPart.CFrame = temple.CFrame * CFrame.new(0, 10, 0)
        task.wait(2)
        StatusIndicator:Set("Status: At Temple âœ“")
        self.CurrentStep = 4
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Temple not found!",
            Duration = 5
        })
    end
end

function V4System:StartTrial()
    StatusIndicator:Set("Status: Starting Trial...")
    
    local entity = nil
    for _, npc in pairs(Workspace.NPCs:GetChildren()) do
        if npc.Name == "Mysterious Entity" then
            entity = npc
            break
        end
    end
    
    if entity then
        -- Approach entity
        local humanoid = entity:FindFirstChild("Humanoid")
        if humanoid then
            RootPart.CFrame = entity.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
            task.wait(1)
            
            -- Start conversation
            fireclickdetector(entity.ClickDetector)
            task.wait(2)
            
            -- Start trial
            ReplicatedStorage.Remotes.CommF_:InvokeServer("MysteriousEntity", "1")
            task.wait(1)
            ReplicatedStorage.Remotes.CommF_:InvokeServer("MysteriousEntity", "2")
            
            Rayfield:Notify({
                Title = "Trial",
                Content = "V4 Trial Started!",
                Duration = 3
            })
            
            StatusIndicator:Set("Status: Trial Active")
            self.CurrentStep = 5
        end
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Mysterious Entity not found!",
            Duration = 5
        })
    end
end

function V4System:CompleteTrialObjectives()
    StatusIndicator:Set("Status: Completing Trial...")
    
    -- Function to kill angels
    local function KillAngels()
        while self.TrialData.Angels.Killed < self.TrialData.Angels.Required do
            for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
                if enemy.Name == "Angel" and enemy.Humanoid.Health > 0 then
                    -- Attack angel
                    RootPart.CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, getgenv().FarmDistance or 20)
                    
                    -- Use combat
                    task.spawn(function()
                        game:GetService("VirtualUser"):CaptureController()
                        game:GetService("VirtualUser"):Button1Down(Vector2.new(1280, 672))
                    end)
                    
                    if enemy.Humanoid.Health <= 0 then
                        self.TrialData.Angels.Killed += 1
                        ProgressBar:Set((self.TrialData.Angels.Killed / self.TrialData.Angels.Required) * 33)
                    end
                    
                    task.wait(0.5)
                end
            end
            task.wait(1)
        end
    end
    
    -- Function to collect fruits
    local function CollectFruits()
        while self.TrialData.Fruits.Collected < self.TrialData.Fruits.Required do
            for _, obj in pairs(Workspace:GetChildren()) do
                if obj.Name == "Fruit" and obj:IsA("BasePart") then
                    RootPart.CFrame = obj.CFrame
                    task.wait(1)
                    self.TrialData.Fruits.Collected += 1
                    ProgressBar:Set(33 + (self.TrialData.Fruits.Collected / self.TrialData.Fruits.Required) * 33)
                end
            end
            task.wait(1)
        end
    end
    
    -- Function to kill trial boss
    local function KillTrialBoss()
        local boss = nil
        while not boss do
            for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
                if enemy.Name == "Trial Boss" then
                    boss = enemy
                    break
                end
            end
            task.wait(1)
        end
        
        while boss and boss.Humanoid.Health > 0 do
            RootPart.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0, 0, getgenv().FarmDistance or 20)
            
            -- Use combat
            task.spawn(function()
                game:GetService("VirtualUser"):CaptureController()
                game:GetService("VirtualUser"):Button1Down(Vector2.new(1280, 672))
            end)
            
            task.wait(0.5)
        end
        
        ProgressBar:Set(100)
    end
    
    -- Execute objectives
    KillAngels()
    Rayfield:Notify({
        Title = "Trial",
        Content = "Angels defeated: " .. self.TrialData.Angels.Killed .. "/5",
        Duration = 3
    })
    
    CollectFruits()
    Rayfield:Notify({
        Title = "Trial",
        Content = "Fruits collected: " .. self.TrialData.Fruits.Collected .. "/10",
        Duration = 3
    })
    
    KillTrialBoss()
    Rayfield:Notify({
        Title = "Trial",
        Content = "Trial Boss defeated!",
        Duration = 3
    })
    
    self.CurrentStep = 6
end

function V4System:RaceSpecificTask()
    local race = Player.Data.Race.Value
    StatusIndicator:Set("Status: Completing " .. race .. " V4 Task...")
    
    local taskFunctions = {
        Human = function()
            -- Train instinct to 500
            local instinct = Player.Data.Instinct.Value
            if instinct < 500 then
                Rayfield:Notify({
                    Title = "Human V4",
                    Content = "Training instinct: " .. instinct .. "/500",
                    Duration = 3
                })
                
                while instinct < 500 do
                    RootPart.CFrame = CFrame.new(-394.983276, 118.890999, 1245.03516)
                    task.wait(1)
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("KenTalk", "Buy")
                    task.wait(10)
                    instinct = Player.Data.Instinct.Value
                end
            end
            return true
        end,
        
        Mink = function()
            -- Find Thunder God
            local thunderGod = nil
            for _, npc in pairs(Workspace.NPCs:GetChildren()) do
                if npc.Name == "Thunder God" then
                    thunderGod = npc
                    break
                end
            end
            
            if thunderGod then
                RootPart.CFrame = thunderGod.CFrame * CFrame.new(0, 0, 5)
                task.wait(1)
                fireclickdetector(thunderGod.ClickDetector)
                task.wait(2)
                ReplicatedStorage.Remotes.CommF_:InvokeServer("MinkTrainer", "Talk")
                return true
            end
            return false
        end,
        
        Fishman = function()
            -- Find Water Body
            local waterBody = nil
            for _, npc in pairs(Workspace.NPCs:GetChildren()) do
                if npc.Name == "Water Body" then
                    waterBody = npc
                    break
                end
            end
            
            if waterBody then
                RootPart.CFrame = waterBody.CFrame * CFrame.new(0, 0, 5)
                task.wait(1)
                fireclickdetector(waterBody.ClickDetector)
                task.wait(2)
                ReplicatedStorage.Remotes.CommF_:InvokeServer("FishmanQuest", "Start")
                return true
            end
            return false
        end,
        
        Skypiea = function()
            -- Find God's Chalice
            local chalice = nil
            for _, npc in pairs(Workspace.NPCs:GetChildren()) do
                if npc.Name == "God's Chalice" then
                    chalice = npc
                    break
                end
            end
            
            if chalice then
                RootPart.CFrame = chalice.CFrame * CFrame.new(0, 0, 5)
                task.wait(1)
                fireclickdetector(chalice.ClickDetector)
                task.wait(2)
                ReplicatedStorage.Remotes.CommF_:InvokeServer("SkyExp", "Check")
                return true
            end
            return false
        end,
        
        Cyborg = function()
            -- Find and charge Tesla Coil
            local coil = nil
            for _, obj in pairs(Workspace.Map.Desert:GetChildren()) do
                if obj.Name == "TeslaCoil" then
                    coil = obj
                    break
                end
            end
            
            if coil then
                RootPart.CFrame = coil.CFrame * CFrame.new(0, 5, 0)
                task.wait(1)
                
                -- Charge coil
                fireproximityprompt(coil.ProximityPrompt)
                Rayfield:Notify({
                    Title = "Cyborg V4",
                    Content = "Charging Tesla Coil (30s)...",
                    Duration = 30
                })
                task.wait(30)
                
                -- Buy Gear 4
                ReplicatedStorage.Remotes.CommF_:InvokeServer("CyborgTrainer", "Buy")
                return true
            end
            return false
        end,
        
        Ghoul = function()
            -- Check ectoplasm
            local ecto = Player.Data.Ectoplasm.Value
            if ecto < 50 then
                Rayfield:Notify({
                    Title = "Ghoul V4",
                    Content = "Farming ectoplasm: " .. ecto .. "/50",
                    Duration = 3
                })
                
                -- Farm ectoplasm
                while ecto < 50 do
                    RootPart.CFrame = CFrame.new(-9515.75391, 174.213226, 6074.89404)
                    task.wait(1)
                    
                    -- Attack Soul Reaper
                    for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
                        if enemy.Name == "Soul Reaper" then
                            RootPart.CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                            task.wait(0.5)
                            game:GetService("VirtualUser"):CaptureController()
                            game:GetService("VirtualUser"):Button1Down(Vector2.new(1280, 672))
                            break
                        end
                    end
                    
                    task.wait(5)
                    ecto = Player.Data.Ectoplasm.Value
                end
            end
            
            -- Buy Ghoul Mask if needed
            local hasMask = false
            for _, item in pairs(Player.Backpack:GetChildren()) do
                if item.Name == "Ghoul Mask" then
                    hasMask = true
                    break
                end
            end
            
            if not hasMask then
                ReplicatedStorage.Remotes.CommF_:InvokeServer("Ectoplasm", "Buy", 4)
                task.wait(1)
            end
            
            -- Equip mask and transform
            local mask = Player.Backpack:FindFirstChild("Ghoul Mask")
            if mask then
                Humanoid:EquipTool(mask)
            end
            
            ReplicatedStorage.Remotes.CommF_:InvokeServer("Ectoplasm", "Change", 4)
            return true
        end
    }
    
    if taskFunctions[race] then
        local success = taskFunctions[race]()
        if success then
            StatusIndicator:Set("Status: " .. race .. " Task Complete âœ“")
            self.CurrentStep = 7
        else
            Rayfield:Notify({
                Title = "Error",
                Content = "Failed " .. race .. " V4 task!",
                Duration = 5
            })
        end
    end
end

function V4System:FinalizeTrial()
    StatusIndicator:Set("Status: Finalizing Trial...")
    
    task.wait(3)
    ReplicatedStorage.Remotes.CommF_:InvokeServer("MysteriousEntity", "3")
    
    Rayfield:Notify({
        Title = "Trial",
        Content = "Trial Completed!",
        Duration = 3
    })
    
    self.CurrentStep = 8
end

function V4System:AcquireV4()
    StatusIndicator:Set("Status: Acquiring V4...")
    
    -- Wait for V4 to activate
    task.wait(5)
    
    -- Check if V4 was acquired
    if Player.Data.Race:FindFirstChild("AwakenedMoves") then
        Rayfield:Notify({
            Title = " CONGRATULATIONS!",
            Content = "V4 RACE ACQUIRED!",
            Duration = 10
        })
        
        -- Send webhook notification
        if getgenv().WebhookURL then
            SendWebhook("V4 Acquired", "Successfully obtained " .. Player.Data.Race.Value .. " V4!")
        end
        
        ProgressBar:Set(100)
        StatusIndicator:Set("Status: V4 ACQUIRED! âœ“")
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Failed to acquire V4!",
            Duration = 5
        })
    end
    
    self.Active = false
end

function V4System:Stop()
    self.Active = false
    StatusIndicator:Set("Status: Stopped")
end

V4System:Initialize()

-- ============================================
-- UTILITY FUNCTIONS (500 lines)
-- ============================================
function UpdateAllStats()
    RaceLabel:Set("Race: " .. Player.Data.Race.Value)
    StageLabel:Set("Stage: V" .. Player.Data.Race.Stage.Value)
    LevelLabel:Set("Level: " .. Player.Data.Level.Value)
    BeliLabel:Set("Beli: " .. Player.Data.Beli.Value)
    FragmentsLabel:Set("Fragments: " .. Player.Data.Fragments.Value)
    
    Rayfield:Notify({
        Title = "Stats",
        Content = "All stats refreshed!",
        Duration = 2
    })
end

function TeleportToLocation(location)
    local locations = {
        Mirage = CFrame.new(28282.5703, 14896.8506, 105.104271),
        Temple = function()
            for _, obj in pairs(Workspace.Map:GetChildren()) do
                if obj.Name == "TempleOfTime" then
                    return obj.CFrame
                end
            end
            return nil
        end,
        Tesla = function()
            for _, obj in pairs(Workspace.Map.Desert:GetChildren()) do
                if obj.Name == "TeslaCoil" then
                    return obj.CFrame
                end
            end
            return nil
        end,
        Haunted = CFrame.new(-9515.75391, 174.213226, 6074.89404),
        Waterfall = CFrame.new(-11593.5, 331.5, -10547.1)
    }
    
    local target = locations[location]
    if target then
        if type(target) == "function" then
            local result = target()
            if result then
                RootPart.CFrame = result
            else
                Rayfield:Notify({
                    Title = "Error",
                    Content = location .. " not found!",
                    Duration = 3
                })
                return
            end
        else
            RootPart.CFrame = target
        end
        
        Rayfield:Notify({
            Title = "Teleport",
            Content = "Teleported to " .. location,
            Duration = 3
        })
    end
end

function CheckV4Requirements()
    local race = Player.Data.Race.Value
    local level = Player.Data.Level.Value
    local stage = Player.Data.Race.Stage.Value
    
    local messages = {}
    
    if level < 2300 then
        table.insert(messages, "âŒ Need level 2300 (Current: " .. level .. ")")
    else
        table.insert(messages, "âœ… Level: " .. level .. "/2300")
    end
    
    if stage < 3 then
        table.insert(messages, "âŒ Need Race V3 (Current: V" .. stage .. ")")
    else
        table.insert(messages, "âœ…
